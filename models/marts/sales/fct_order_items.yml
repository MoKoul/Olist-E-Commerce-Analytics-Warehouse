# models/marts/sales/fct_order_items.yml

version: 2

models:

  - name: fct_order_items
    description: |
      Fact table at order-item grain (one row per line item in an order).
      Core sales metrics including price, freight, total payment, review score.
      Matches row count of stg_olist__order_items for data integrity. Partitioned by 
      order_purchase_date (month).
    
    tests:
      - dbt_utils.equal_rowcount:
          arguments:
            compare_model: ref('stg_olist__order_items')
      
      - dbt_utils.expression_is_true:
          arguments:
            expression: "item_price >= 0"
            description: "Item price cannot be negative"
            severity: error
      - dbt_utils.expression_is_true:
          arguments:
            expression: "order_shipping_cost_amount >= 0"
            description: "Duplicated shipping cost cannot be negative"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "customer_paid_amount >= 0"
            description: "Duplicated paid amount cannot be negative"
    
    columns:
      - name: order_item_sk
        description: "Primary surrogate key of the fact table (order_id + order_item_id)"
        tests: [unique, not_null]

      - name: order_sk
        description: "Surrogate key for the order (order_id)"

      - name: customer_sk
        description: "Foreign key to dim_customer"
        tests:
          - relationships:
              arguments:
                 to: ref('dim_customer')
                 field: customer_sk
          - not_null

      - name: seller_sk
        description: "Foreign key to dim_seller"
        tests:
          - relationships:
              arguments:
                 to: ref('dim_seller')
                 field: seller_sk
          - not_null

      - name: product_sk
        description: "Foreign key to dim_product"
        tests:
          - relationships:
              arguments:
                 to: ref('dim_product')
                 field: product_sk
          - not_null

      - name: date_key
        description: "Date key (YYYYMMDD) for joining to dim_date (purchase date)"
        tests:
          - relationships:
              arguments:
                 to: ref('dim_date')
                 field: date_key
          - not_null

      - name: item_price
        description: "Price of the item (excluding freight)"

      - name: order_shipping_cost_amount
        description: "Total order-level shipping cost, duplicated across all items in the stg_olist__order_items table"

      - name: customer_paid_amount
        description: "Total amount paid by customer for the entire order (aggregated from payments)"

      - name: payment_installments_count
        description: "Highest number of installments across order payments (0 if none)"

      - name: order_review_score_avg
        description: "Average review score for the order (1-5 stars; 0 if no reviews)"

      - name: order_status
        description: "Current order status (e.g., delivered, shipped, canceled)"

      - name: order_purchase_date
        description: "Date as YYYYMMDD for the time order was placed"

      - name: order_purchase_timestamp
        description: "Timestamp when the order was placed"

      - name: order_approved_timestamp
        description: "Timestamp when the order was approved"

      - name: order_delivered_carrier_timestamp
        description: "Timestamp when handed to carrier"

      - name: order_delivered_customer_timestamp
        description: "Timestamp when delivered to customer"

      - name: order_estimated_delivery_timestamp
        description: "Original estimated delivery timestamp"          




    